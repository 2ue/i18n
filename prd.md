# 国际化提取替换翻译工具

我们正在设计一个i18n扫描和替换，翻译工具，主要功能是扫描项目中的中文文案，提取并替换为国际化函数（如`$t('key')`），同时生成对应的多语言JSON文件。
工具支持、扫描，替换，翻译集成、自动导入管理国际化函数等功能。
现阶段只需要实现提取react项目中的js,jsx,ts,tsx文件，保留拓展后续支持vue和vue的jsx/tsx能力，以及后续像其他框架拓展的能力


## 基础技术栈
- **包管理**：pnpm
- **语言**：TypeScript
- **运行环境**：Node.js

尽可能使用社区成熟的最优工具来实现程序的简化和智能，比如使用lodas-es，使用fs-extra，使用fast-glob，但不要过度的引入大量依赖
在引入其他依赖时也需要考虑是否最优以及是否有必要

## 要求文件：
1、[配置文件](./configuration.md)
1、[需要支持的case示例](./case.md)

建议：
1、使用ast遍历提取所有的中文特征字符串
3、引入依赖应该考虑兼容性，并且需要考虑是否支持es和cjs
4、尽可能的简化模块实现，但需要满足要求的功能
5、测试用例最后实现，并且希望考虑所有要求的case和覆盖要求的配置
6、请严格按照配置文件实现，禁止再去拓展配置，并且配置都统一到入口处进行加载，其余地方直接调用合并后的配置不需要
7、技术实现要考虑拓展性和易用性以及可维护性以及简化，但是不要过于追求设计导致程序难以理解，同时也不要太过去考虑拓展性，导致写很复杂的适配，只需要留下拓展空间就行，没必要后续费拓展在现在做很复杂的设计
8、全程都使用ts实现严禁ts和js混用
9、如果要固化node和pnpm等版本，需要先检查本地的node版本和pnpm

- 初始化
  - 初始化：使用pnpm初始化
  - 增加ts配置：增加ts的配置并增加打包
  - eslint配置：增加eslint和保存自动格式化配置
  - 基础目录构建：构建基本的目录
  - 基础信息修改：修改package.json等的基本信息

- 配置加载器：所有的配置管理都收敛到一起进行管理，默认使用ts，也支持js和json，配置名为i18n.config.{ts,js,json}
  - ts定义：复杂的配置选项也需要配置
  - 全量配置：一份全量的配置，用于后面查看，需要注释
  - 默认配置：一份默认的配置，不需要的配置需要去掉，只保留默认配置
  - 加载配置器：使用自定义配置（允许没有自定义配置）合并(lodash的merge)默认配置，加载之后其他地方就不用加载了，直接使用，最好使用配置管理器来实现
  - 配置验证器：验证关键的配置
  
- 全局变量
 - 可能用到的全局变量需要统一管理

- 文件操作：其他模块可能会用到的文件操作，全都使用sync方法，全都收敛到这里，并且这里可能会读取，这些配置用在某些文件操作，所有的文件操作都是基于当前的cli执行的目录（特殊指定或者使用绝对路径的除外）
  - 读取文件：基础的读取文件，使用fs-extra实现
  - 写入文件：基础的写入文件，使用fs-extra实现
  - 查找文件：查找文件，主要使用fast-glob来实现
  - 创建目录：安全的创建目录，使用fs-extra实现
  - 检查文件是否存在：检查文件或者目录是否存在，使用fs-extra实现
  - 检查文件是否在符合glob规则：比如src/pages/index.ts是否符合src/**/*.{ts,tsx}
  - 读取json：提供读json的能力
  - 写入json：提供写json的能力

- 匹配规则定义
 - 定义匹配中文文案的规则：支持两种匹配模式：模式1必须全是中文，模式2至少包含一个中文。根据配置选择

- key-value管理器：用于初始化缓存keys，重复判断，key生成等操作
  - value重复判断：判断提取的文本是否已经在提取内容内了
  - key重复判断：判断key是否重复
  - 生成key：根据配置（比如是否复用重复key，生成pinyin等等），中文，决定是否生成以及如何生成唯一key，无论key是否生成，都需要返回对应的ke，如果需要生成pinyin需要使用pinyin-pro
  - value生成器，对应字符串模版的内容如何生成（一般是模式2才需要复杂处理，纯中文直接使用它作为key）
  - value获取：根据key获取value
  - 排序
  - 写入key-value到json文件：根据配置指定位置和模式

- 替换管理器：用于管理替换逻辑
  - 替换管理器：根据配置实现不同的替换方法，比如单引号，双引号，支持参数（参数是数组）等

- import自动导入管理器：用于处理当使用$t函数替换后，需要导入国际化函数问题，需要方便拓展
  - 检查是否已经引入：如果已经引入则不需要再次引入
  - 是否发现替换：如果发生替换，则需要插入国际化函数
  - 插入国际化函数：插入国际化函数（函数可能是多行），并且需要保持前后是单独一行（@babel/parase处理不了，需要结合@babel/types来处理）

- 日志管理：用于管理日志的输出
  - 日志输出：根据配置，输出日志
  - 日志格式：日志格式，比如时间，日志级别，日志内容等
  - 日志级别：日志级别，比如info，warning，error等

- ast处理器：需要方便拓展
  - 获取文件：使用文件操作模块的方法获取
  - ast遍历处理：不同的文件使用不同的方法进行遍历
  - 提取case处理：根据case场景，匹配中文，实现不同的提取方法，来处理不同的case
  - 替换case处理：根据提取的中文，生成key-value和配置，来实现替换与否
  - ast回写：需要根据配置判断是否回写，是否替换，是否回写到临时文件夹

- 翻译处理器：需要方便拓展支持多平台翻译
  - 队列管理：对翻译调用频率，错误重试次数等进行管理
  - providers实现：针对不同的平台封装相同协议的翻译provider
  - 翻译实现：根据配置，队列，provider等实现翻译主功能
  - 目前只需要支持百度翻译平台，其他不需要支持，但是需要保留拓展性


- cli实现：
  - 实现help和version
  - 实现init，使用默认配置初始化配置，支持自定义配置生成路径（默认根路径下的i18n.config.js），指定生成何种格式的配置文件（ts,js,json,默认ts）
  - 实现replace，仅替换文案
  - 实现extract，默认仅扫描文件（可以指定参数实现扫描且替换），会根据配置生成对应的locales json文件，支持指定配置文件路径
  - 实现translate，翻译文案，默认根据配置配置文件内参数对指定文件的json翻译，也可以指定参数

- 主流程：
  - 初始化：初始化配置，初始化缓存keys，初始化key-value管理器，初始化import自动导入管理器，初始化替换管理器
  - 扫描：扫描文件，提取中文文案，替换文案，输出json，输出替换后代码文件
